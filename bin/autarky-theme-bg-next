#!/bin/zsh

# Cycles through the background images available

BACKGROUNDS_DIR="$HOME/.config/autarky/current/theme/backgrounds/"
CURRENT_BACKGROUND_LINK="$HOME/.config/autarky/current/background"

BACKGROUNDS=()
while IFS= read -r -d '' file; do
  BACKGROUNDS+=("$file")
done < <(find "$BACKGROUNDS_DIR" -type f -print0 | sort -z)
TOTAL=${#BACKGROUNDS[@]}

if [[ $TOTAL -eq 0 ]]; then
  notify-send "No background was found for theme" -t 2000
  pkill -x swaybg
  setsid uwsm app -- swaybg --color '#000000' >/dev/null 2>&1 &
else
  # Get current background from symlink
  if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
    CURRENT_BACKGROUND=$(readlink $CURRENT_BACKGROUND_LINK)
  else
    # Default to first background if no symlink exists
    CURRENT_BACKGROUND=""
  fi

  # Find current background index
  INDEX=-1
  for i in {1..$TOTAL}; do
    if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
      INDEX=$i
      break
    fi
  done

  # Get next background (wrap around)
  MODE="fill"
  if [[ $INDEX -eq -1 ]]; then
    # Use the first background when no match is found
    NEW_BACKGROUND="${BACKGROUNDS[1]}"
  else
    NEXT_INDEX=$((INDEX % TOTAL))
    NEW_BACKGROUND="${BACKGROUNDS[($NEXT_INDEX + 1)]}"
    IFS='-' read -A parts <<< "$NEW_BACKGROUND"
    MODE="$parts[2]"
  fi

  # Set new background symlink
  ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"
  # Refresh pywal
  # if [[ -f ~/.config/autarky/current/theme/light.mode ]]; then
  #   wal --backend colorz -l -i $NEW_BACKGROUND
  # else
  #   wal --backend colorz -i $NEW_BACKGROUND
  # fi
  # autarky-theme-apply-wal
  # Trigger kitty config reload
  # kitty @ load-config
  # Relaunch swaybg
  pkill -x swaybg
  setsid uwsm app -- swaybg -i "$CURRENT_BACKGROUND_LINK" -m "$MODE" >/dev/null 2>&1 &
fi
